(function(o,m){typeof exports=="object"&&typeof module<"u"?module.exports=m(require("vue")):typeof define=="function"&&define.amd?define(["vue"],m):(o=typeof globalThis<"u"?globalThis:o||self,o["vue3-puzzle-vcode"]=m(o.Vue))})(this,function(o){"use strict";var m=document.createElement("style");m.textContent=`.vue-puzzle-vcode{position:fixed;top:0;left:0;bottom:0;right:0;background-color:#0000004d;z-index:999;opacity:0;pointer-events:none;transition:opacity .2s}.vue-puzzle-vcode.show_{opacity:1;pointer-events:auto}.vue-auth-box_{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);padding:20px;background:#fff;user-select:none;border-radius:3px;box-shadow:0 1px 3px #0000004d}.vue-auth-box_ .auth-body_{position:relative;overflow:hidden;border-radius:3px}.vue-auth-box_ .auth-body_ .loading-box_{position:absolute;top:0;left:0;bottom:0;right:0;background-color:#000c;z-index:20;opacity:1;transition:opacity .1s;display:flex;align-items:center;justify-content:center}.vue-auth-box_ .auth-body_ .loading-box_.hide_{opacity:0;pointer-events:none}.vue-auth-box_ .auth-body_ .loading-box_.hide_ .loading-gif_ span{animation-play-state:paused}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_{flex:none;height:5px;line-height:0}@keyframes load{0%{opacity:1;transform:scale(1.3)}to{opacity:.2;transform:scale(.3)}}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span{display:inline-block;width:5px;height:100%;margin-left:2px;border-radius:50%;background-color:#888;animation:load 1.04s ease infinite}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span:nth-child(1){margin-left:0}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span:nth-child(2){animation-delay:.13s}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span:nth-child(3){animation-delay:.26s}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span:nth-child(4){animation-delay:.39s}.vue-auth-box_ .auth-body_ .loading-box_ .loading-gif_ span:nth-child(5){animation-delay:.52s}.vue-auth-box_ .auth-body_ .info-box_{position:absolute;bottom:0;left:0;width:100%;height:24px;line-height:24px;text-align:center;overflow:hidden;font-size:13px;background-color:#83ce3f;opacity:0;transform:translateY(24px);transition:all .2s;color:#fff;z-index:10}.vue-auth-box_ .auth-body_ .info-box_.show{opacity:.95;transform:translateY(0)}.vue-auth-box_ .auth-body_ .info-box_.fail{background-color:#ce594b}.vue-auth-box_ .auth-body_ .auth-canvas2_{position:absolute;top:0;left:0;width:60px;height:100%;z-index:2}.vue-auth-box_ .auth-body_ .auth-canvas3_{position:absolute;top:0;left:0;opacity:0;transition:opacity .6s;z-index:3}.vue-auth-box_ .auth-body_ .auth-canvas3_.show{opacity:1}.vue-auth-box_ .auth-body_ .flash_{position:absolute;top:0;left:0;width:30px;height:100%;background-color:#ffffff1a;z-index:3}.vue-auth-box_ .auth-body_ .flash_.show{transition:transform .6s}.vue-auth-box_ .auth-body_ .reset_{position:absolute;top:2px;right:2px;width:35px;height:auto;z-index:12;cursor:pointer;transition:transform .2s;transform:rotate(0)}.vue-auth-box_ .auth-body_ .reset_:hover{transform:rotate(-90deg)}.vue-auth-box_ .auth-control_ .range-box{position:relative;width:100%;background-color:#eef1f8;margin-top:20px;border-radius:3px;box-shadow:0 0 8px #f0f0f099 inset}.vue-auth-box_ .auth-control_ .range-box .range-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;color:#b7bcd1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center;width:100%}.vue-auth-box_ .auth-control_ .range-box .range-slider{position:absolute;height:100%;width:50px;background-color:#6aa0ffcc;border-radius:3px}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn{position:absolute;display:flex;align-items:center;justify-content:center;right:0;width:50px;height:100%;background-color:#fff;border-radius:3px;box-shadow:0 0 4px #ccc;cursor:pointer}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn>div{width:0;height:40%;transition:all .2s;border:solid 1px #6aa0ff}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn>div:nth-child(2){margin:0 4px}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn:hover>div:first-child,.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn.isDown>div:first-child{border:solid 4px transparent;height:0;border-right-color:#6aa0ff}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn:hover>div:nth-child(2),.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn.isDown>div:nth-child(2){border-width:3px;height:0;border-radius:3px;margin:0 6px;border-right-color:#6aa0ff}.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn:hover>div:nth-child(3),.vue-auth-box_ .auth-control_ .range-box .range-slider .range-btn.isDown>div:nth-child(3){border:solid 4px transparent;height:0;border-left-color:#6aa0ff}.vue-puzzle-overflow{overflow:hidden!important}
`,document.head.appendChild(m);const N="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAELklEQVRYR+2YW2wUZRTH//9vtlCoF9IoIklT3PqgPGi326hoetuaGEhIr9SgCYkkgt2WGOQVCca+GavWdr0GjD4YhG3RB3hply1LQA1tEQIxEXapGI2pEkys9LIzx2ylYWfY6e5sF0oi+7hzzvl+3/9855xvhrjNf7zN+XAHcL4Z+n8o6JWTeYt++W25S596AIZy6TB+n3yo+Nchlk8vmIIVowdXU9c3Q1gDSilBlQwjgBAYFGDvdF58/4milqvZwDpOcXWsb5Uh8hmBqkwXFMhlCN8aX5LXNbRy/T+Z+iXsHAFWRXs3QGQPyLucLDJrK5DgUXdTsxPfjAEro8E3Ce50EtxsKxPTwCPH3U2jTmJkBJgWTnAMxDeGMEoa0xQ+LJQnCD4HYFkCyAC3RdwN3U7gMkpxRTTYrMD91sCJIgCxV5R6O1Jcfy7VwonqLoj9/CqB2kF341qncGkBvRe+ureAWpRgoalCBecMFzcdK24YymZRJz5zprgq1tsJwXYL3CVZGvdGHmwZc7JQtra2gE+f712ep2QUYP714DJhaJrXLqXZQszlZwtYdSHoB9ljVk/ePVrSZFL0ZkAlxzQBVseCT8WhZhRThtFB8plk9Zi/qCi8cv0fNxvKFrDy4oF11NXXIFy2EII4iBcG3Y03VLZT8OqRd5aFPduvOEpxRayvXolxAKB2g6NgEhobBlc1HHYKY7WvHf5wtVAPgegIlbbZ9seUZ7AyFnwewi9pGoUyDmhrB931kfnC1ZwOeKlLP8GZJi6QLSFP2yep4toXSbT3ZQAfX3O6omt8Nhd9r/aHQAUMOQywYBZo5uZD2ThQ2rbPCjlnH6yI9rUryE5DU75ctJaake46Be4DuDjF8dFBNA94/AdtiySVxIlpMlTS8td801o70vMigM9huTda2lhcKHVHPO2HZv/P6LIwX7hk/+qzPSvUJGMkrg8AQYTkroRdXMlE+HH/twsG6BsOdJHYZlaO/lBZ6weOiiSXqs3Gqj0TeAxx+T75DIpgwjC0onD51pQD4JaluPrkR/cpFT9DcoVp84LOgTL/DjtBbglgou+puHwB8lEznPxJw1XSX77VtgizBvQNBw4RMqB7xt4Lc3c8lQKJaQHoO4R8ydz0/7MWoCXk8c85MrMC9J3qaafw/WtQlwXST+F3BnAeYB4obgJ1BJIuG+YtiKAjVOZ/Pd1ZdwzoG+4uBtSPpjaRbhXLcwF3hzytb2TilgVgT5BkYybBrTYC+Rvg5nRpdTRJrIs8+VPXPQXj2i4ItxC4O2NQQUQnN4U9rRcz9nH64p4ceM2lziX5Y4s3KHCdUHwE77ecMkMEp6BwhIa2Z6DslZRvfulgHafYLuCas58WLp2aLCFUga70qxOFU6dPFL2W1feYeaU43Y5z/TxnCuYabMEuC043ckdBp4pZ7f8FE5psOI1g6fwAAAAASUVORK5CYII=",V=["width","height"],W=["width","height"],H=["width","height"],I=[o.createElementVNode("div",{class:"loading-gif_"},[o.createElementVNode("span"),o.createElementVNode("span"),o.createElementVNode("span"),o.createElementVNode("span"),o.createElementVNode("span")],-1)],R={class:"auth-control_"},L={class:"range-text"},F=[o.createElementVNode("div",null,null,-1),o.createElementVNode("div",null,null,-1),o.createElementVNode("div",null,null,-1)],O=o.defineComponent({__name:"App",props:{canvasWidth:{type:Number,default:310},canvasHeight:{type:Number,default:160},show:{type:Boolean,default:!1},puzzleScale:{type:Number,default:1},sliderSize:{type:Number,default:50},range:{type:Number,default:10},imgs:{type:Array,default:null},successText:{type:String,default:"验证通过！"},failText:{type:String,default:"验证失败，请重试"},sliderText:{type:String,default:"拖动滑块完成拼图"}},emits:["success","fail","close"],setup(l,{emit:_}){const i=l;o.onMounted(()=>{document.addEventListener("mousemove",b,!1),document.addEventListener("mouseup",v,!1),document.addEventListener("touchmove",b,{passive:!1}),document.addEventListener("touchend",v,!1),i.show&&(document.body.classList.add("vue-puzzle-overflow"),y())}),o.onUnmounted(()=>{e.timer1&&clearTimeout(e.timer1),document.removeEventListener("mousemove",b,!1),document.removeEventListener("mouseup",v,!1),document.removeEventListener("touchmove",b),document.removeEventListener("touchend",v,!1)});const T=o.ref(),Y=o.ref(),C=o.ref(),E=o.ref(),e=o.reactive({mouseDown:!1,startWidth:50,startX:0,newX:0,pinX:0,pinY:0,loading:!1,isCanSlide:!1,error:!1,infoBoxShow:!1,infoText:"",infoBoxFail:!1,timer1:void 0,closeDown:!1,isSuccess:!1,imgIndex:-1,isSubmting:!1});o.watch(()=>i.show,n=>{n?(document.body.classList.add("vue-puzzle-overflow"),y()):(e.isSubmting=!1,e.isSuccess=!1,e.infoBoxShow=!1,document.body.classList.remove("vue-puzzle-overflow"))});const x=o.computed(()=>{const n=e.startWidth+e.newX-e.startX;return n<d.value?d.value:n>i.canvasWidth?i.canvasWidth:n}),r=o.computed(()=>Math.round(Math.max(Math.min(i.puzzleScale,2),.2)*52.5+6)),d=o.computed(()=>Math.max(Math.min(Math.round(i.sliderSize),Math.round(i.canvasWidth*.5)),10)),P=()=>{!e.mouseDown&&!e.isSubmting&&(e.timer1&&clearTimeout(e.timer1),_("close"))},M=()=>{e.closeDown=!0},B=()=>{e.closeDown&&P(),e.closeDown=!1},A=n=>{var t;e.isCanSlide&&(e.mouseDown=!0,e.startWidth=((t=T.value)==null?void 0:t.clientWidth)??0,e.newX=n.clientX||n.changedTouches[0].clientX,e.startX=n.clientX||n.changedTouches[0].clientX)},b=n=>{e.mouseDown&&(n.preventDefault(),e.newX=n.clientX||n.changedTouches[0].clientX)},v=()=>{e.mouseDown&&(e.mouseDown=!1,U())},k=(n=!1)=>{var D;if(e.loading&&!n)return;e.loading=!0,e.isCanSlide=!1;const t=Y.value,h=C.value,c=E.value,a=t==null?void 0:t.getContext("2d",{willReadFrequently:!0}),g=h==null?void 0:h.getContext("2d"),u=c==null?void 0:c.getContext("2d");if(!a||!g||!u){console.error("not found ctx / ctx2 / ctx3");return}const $=navigator.userAgent.indexOf("Firefox")>=0&&navigator.userAgent.indexOf("Windows")>=0,p=document.createElement("img");if(a.fillStyle="rgba(255,255,255,1)",u.fillStyle="rgba(255,255,255,1)",a.clearRect(0,0,i.canvasWidth,i.canvasHeight),g.clearRect(0,0,i.canvasWidth,i.canvasHeight),e.pinX=s(r.value+20,i.canvasWidth-r.value-10),e.pinY=s(20,i.canvasHeight-r.value-10),p.crossOrigin="anonymous",p.onload=()=>{const[f,S,X,z]=Z(p);a.save(),w(a),a.closePath(),$?(a.clip(),a.save(),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowColor="#000",a.shadowBlur=3,a.fill(),a.restore()):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowColor="#000",a.shadowBlur=3,a.fill(),a.clip()),a.drawImage(p,f,S,X,z),u.fillRect(0,0,i.canvasWidth,i.canvasHeight),u.drawImage(p,f,S,X,z),a.globalCompositeOperation="source-atop",w(a),a.arc(e.pinX+Math.ceil(r.value/2),e.pinY+Math.ceil(r.value/2),r.value*1.2,0,Math.PI*2,!0),a.closePath(),a.shadowColor="rgba(255, 255, 255, .8)",a.shadowOffsetX=-1,a.shadowOffsetY=-1,a.shadowBlur=Math.min(Math.ceil(8*i.puzzleScale),12),a.fillStyle="#ffffaa",a.fill();const G=a.getImageData(e.pinX-3,e.pinY-20,e.pinX+r.value+5,e.pinY+r.value+5);g.putImageData(G,0,e.pinY-20),a.restore(),a.clearRect(0,0,i.canvasWidth,i.canvasHeight),a.save(),w(a),a.globalAlpha=.8,a.fillStyle="#ffffff",a.fill(),a.restore(),a.save(),a.globalCompositeOperation="source-atop",w(a),a.arc(e.pinX+Math.ceil(r.value/2),e.pinY+Math.ceil(r.value/2),r.value*1.2,0,Math.PI*2,!0),a.shadowColor="#000",a.shadowOffsetX=2,a.shadowOffsetY=2,a.shadowBlur=16,a.fill(),a.restore(),a.save(),a.globalCompositeOperation="destination-over",a.drawImage(p,f,S,X,z),a.restore(),e.loading=!1,e.isCanSlide=!0},p.onerror=()=>{k(!0)},!n&&((D=i.imgs)!=null&&D.length)){let f=s(0,i.imgs.length-1);f===e.imgIndex&&(f===i.imgs.length-1?f=0:f++),e.imgIndex=f,p.src=i.imgs[f]}else p.src=Q()},s=(n,t)=>Math.ceil(Math.random()*(t-n)+n),Z=n=>{const t=n.width/n.height,h=i.canvasWidth/i.canvasHeight;let c=0,a=0,g=0,u=0;return t>h?(u=i.canvasHeight,g=t*u,a=0,c=(i.canvasWidth-g)/2):(g=i.canvasWidth,u=g/t,c=0,a=(i.canvasHeight-u)/2),[c,a,g,u]},w=n=>{const t=Math.ceil(15*i.puzzleScale);n.beginPath(),n.moveTo(e.pinX,e.pinY),n.lineTo(e.pinX+t,e.pinY),n.arcTo(e.pinX+t,e.pinY-t/2,e.pinX+t+t/2,e.pinY-t/2,t/2),n.arcTo(e.pinX+t+t,e.pinY-t/2,e.pinX+t+t,e.pinY,t/2),n.lineTo(e.pinX+t+t+t,e.pinY),n.lineTo(e.pinX+t+t+t,e.pinY+t),n.arcTo(e.pinX+t+t+t+t/2,e.pinY+t,e.pinX+t+t+t+t/2,e.pinY+t+t/2,t/2),n.arcTo(e.pinX+t+t+t+t/2,e.pinY+t+t,e.pinX+t+t+t,e.pinY+t+t,t/2),n.lineTo(e.pinX+t+t+t,e.pinY+t+t+t),n.lineTo(e.pinX,e.pinY+t+t+t),n.lineTo(e.pinX,e.pinY+t+t),n.arcTo(e.pinX+t/2,e.pinY+t+t,e.pinX+t/2,e.pinY+t+t/2,t/2),n.arcTo(e.pinX+t/2,e.pinY+t,e.pinX,e.pinY+t,t/2),n.lineTo(e.pinX,e.pinY)},Q=()=>{const n=document.createElement("canvas"),t=n.getContext("2d");if(!t)return console.error("not found ctx"),"";n.width=i.canvasWidth,n.height=i.canvasHeight,t.fillStyle=`rgb(${s(100,255)},${s(100,255)},${s(100,255)})`,t.fillRect(0,0,i.canvasWidth,i.canvasHeight);for(let h=0;h<12;h++)if(t.fillStyle=`rgb(${s(100,255)},${s(100,255)},${s(100,255)})`,t.strokeStyle=`rgb(${s(100,255)},${s(100,255)},${s(100,255)})`,s(0,2)>1)t.save(),t.rotate(s(-90,90)*Math.PI/180),t.fillRect(s(-20,n.width-20),s(-20,n.height-20),s(10,n.width/2+10),s(10,n.height/2+10)),t.restore();else{t.beginPath();const c=s(-Math.PI,Math.PI);t.arc(s(0,n.width),s(0,n.height),s(10,n.height/2+10),c,c+Math.PI*1.5),t.closePath(),t.fill()}return n.toDataURL("image/png")},U=()=>{e.isSubmting=!0;const n=Math.abs(e.pinX-(x.value-d.value)+(r.value-d.value)*((x.value-d.value)/(i.canvasWidth-d.value))-3);n<i.range?(e.infoText=i.successText,e.infoBoxFail=!1,e.infoBoxShow=!0,e.isCanSlide=!1,e.isSuccess=!0,e.timer1&&clearTimeout(e.timer1),e.timer1=setTimeout(()=>{e.isSubmting=!1,_("success",n)},800)):(e.infoText=i.failText,e.infoBoxFail=!0,e.infoBoxShow=!0,e.isCanSlide=!1,_("fail",n),e.timer1&&clearTimeout(e.timer1),e.timer1=setTimeout(()=>{e.isSubmting=!1,y()},800))},J=()=>{e.infoBoxFail=!1,e.infoBoxShow=!1,e.isCanSlide=!1,e.isSuccess=!1,e.startWidth=d.value,e.startX=0,e.newX=0},y=()=>{e.isSubmting||(J(),k())};return(n,t)=>(o.openBlock(),o.createBlock(o.Teleport,{to:"body"},[o.createElementVNode("div",{class:o.normalizeClass(["vue-puzzle-vcode",{show_:l.show}]),onMousedown:M,onMouseup:B,onTouchstart:M,onTouchend:B},[o.createElementVNode("div",{class:"vue-auth-box_",onMousedown:t[2]||(t[2]=o.withModifiers(()=>{},["stop"])),onTouchstart:t[3]||(t[3]=o.withModifiers(()=>{},["stop"]))},[o.createElementVNode("div",{class:"auth-body_",style:o.normalizeStyle(`height: ${l.canvasHeight}px`)},[o.createElementVNode("canvas",{ref_key:"canvas1",ref:Y,width:l.canvasWidth,height:l.canvasHeight,style:o.normalizeStyle(`width:${l.canvasWidth}px;height:${l.canvasHeight}px`)},null,12,V),o.createElementVNode("canvas",{ref_key:"canvas3",ref:E,class:o.normalizeClass(["auth-canvas3_",{show:e.isSuccess}]),width:l.canvasWidth,height:l.canvasHeight,style:o.normalizeStyle(`width:${l.canvasWidth}px;height:${l.canvasHeight}px`)},null,14,W),o.createElementVNode("canvas",{ref_key:"canvas2",ref:C,class:"auth-canvas2_",width:o.unref(r),height:l.canvasHeight,style:o.normalizeStyle(`width:${o.unref(r)}px;height:${l.canvasHeight}px;transform:translateX(${o.unref(x)-o.unref(d)-(o.unref(r)-o.unref(d))*((o.unref(x)-o.unref(d))/(l.canvasWidth-o.unref(d)))}px)`)},null,12,H),o.createElementVNode("div",{class:o.normalizeClass(["loading-box_",{hide_:!e.loading}])},I,2),o.createElementVNode("div",{class:o.normalizeClass(["info-box_",{show:e.infoBoxShow},{fail:e.infoBoxFail}])},o.toDisplayString(e.infoText),3),o.createElementVNode("div",{class:o.normalizeClass(["flash_",{show:e.isSuccess}]),style:o.normalizeStyle(`transform: translateX(${e.isSuccess?`${l.canvasWidth+l.canvasHeight*.578}px`:`-${l.canvasHeight*.578}px`}) skew(-30deg, 0);`)},null,6),o.createElementVNode("img",{class:"reset_",onClick:y,src:N})],4),o.createElementVNode("div",R,[o.createElementVNode("div",{class:"range-box",style:o.normalizeStyle(`height:${o.unref(d)}px`)},[o.createElementVNode("div",L,o.toDisplayString(l.sliderText),1),o.createElementVNode("div",{class:"range-slider",ref_key:"rangeSlider",ref:T,style:o.normalizeStyle(`width:${o.unref(x)}px`)},[o.createElementVNode("div",{class:o.normalizeClass(["range-btn",{isDown:e.mouseDown}]),style:o.normalizeStyle(`width:${o.unref(d)}px`),onMousedown:t[0]||(t[0]=h=>A(h)),onTouchstart:t[1]||(t[1]=h=>A(h))},F,38)],4)],4)])],32)],34)]))}}),te="";return O});
